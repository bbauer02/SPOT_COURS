:_chapter:
:_author: Bauer Baptiste
:_duration: 4 heures
:_version_number: 1.0.0
:_version_date: 02/09/2025
[[jobs-pipelines]]
= Jobs et Pipelines avec JENKINS
include::../../../run_app.adoc[]

== Etape 1 : Cr√©ation du d√©p√¥t d'application GIT.

Rendez-vous sur le d√©p√¥t de l'application https://github.com/bbauer02/jenkins-calculatrice[Calculatrice Jenkins] et cliquez sur "Use this template" pour cr√©er votre propre d√©p√¥t √† partir de ce template.

image::images/01.png[]

Il faut ensuite installer et configurer GIT localement dans la machine virtuelle.

[source,bash]
----
sudo apt update && sudo apt install git -y
----

image::images/02.png[]


Il faut ensuite configurer son identit√© GIT :

* Cette configuration est utilis√©e pour les commits :
+
.Modifier les commandes en fonction de vos informations
[source,bash]
----
git config --global user.name "bbauer02"
git config --global user.email "bbauer02@gmail.com"
----
+
* V√©rification de la configuration :
+
[source,bash]
----
git config --list
----
+
Ensuite il faut configurer une cl√© SSH pour pouvoir cloner le d√©p√¥t GIT sans avoir √† saisir vos identifiants √† chaque fois.
+
[source,bash]
----
ssh-keygen -t ed25519 -C "bbauer02@gmail.com"
----
+
D√©marrer l‚Äôagent SSH et ajouter la cl√© :
+
[source,bash]
----
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519
----
+
Afficher la cl√© publique :
+
[source,bash]
----
cat ~/.ssh/id_ed25519.pub
----
+
Copier la *cl√© publique* et l‚Äôajouter dans les param√®tres SSH de votre compte *GitHub*.
+
* https://github.com/settings/keys

image::images/03.png[]

image::images/04.png[]

Dans un dossier `/home/<utilisateur>/app`, cloner le d√©p√¥t GIT de l'application :

[source,bash]
----
mkdir -p ~/app/calculatrice-jenkins
cd ~/app/calculatrice-jenkins
----

Initialiser le d√©p√¥t GIT localement et ajouter le d√©p√¥t distant :

[source,bash]
----
git init
git branch -m main
git config --global init.defaultBranch main
git remote add origin https://github.com/<votre_compte_github>/jenkins-calculatrice.git
git pull origin main
----

[IMPORTANT]
====
*Remarque* : Votre nom d'utilisateur _GitHub_ est sensible √† la casse.
====

Parfait ! nous avons maintenant notre serveur distant qui contient Jenkins d'install√© ainsi que l'application `calculatirice-jenkins` li√© √† un d√©p√¥t *GITHUB*.

== Etape 2 : Cr√©ation de l'image Docker de l'application calculatrice-jenkins

Nous allons maintenant cr√©er l'image Docker de l'application `calculatrice-jenkins` et la pousser sur *Docker Hub*.

[.question]
****
*Q{counter:_question})*
R√©diger un `Dockerfile` pour construire l'image Docker.
//end question
****

// ---------- answer
ifeval::[{_show_correction} == 1]
[.answer]
****
_Correction de Q{_question}_

[source, php]
----
include::code/Dockerfile-calculatrice[]
----
****
endif::[]

ifeval::[{_show_correction} == 0]
[.discreet]#_r√©ponse *{_question}* disponible._#
endif::[]
//  end answer ----------

[.question]
****
*Q{counter:_question})*
R√©diger un `docker-compose.yaml` : gr√¢ce √† ce fichier chaque nouvelle version de l'image pourra √™tre mont√©e facilement :   `docker-compose up -d`
//end question
****


// ---------- answer
ifeval::[{_show_correction} == 1]
[.answer]
****
_Correction de Q{_question}_

[source, yaml]
----
include::code/docker-compose-calculatrice.yaml[]
----

****
endif::[]
ifeval::[{_show_correction} == 0]
[.discreet]#_r√©ponse *{_question}* disponible._#
endif::[]
//  end answer ----------


Il faut maintenant push les 2 fichiers sur le d√©pot GIT distant :

Sur ma machine locale la commande : `git status` me permet de voir les fichiers modifi√©s.

image::images/05.png[]

Je peux ensuite ajouter les fichiers au commit :

[source,bash]
----
git add Dockerfile docker-compose-calculatrice.yaml
ou
git add .
----

Puis je peux faire mon commit :
[source,bash]
----
git commit -m "Ajout du Dockerfile et du docker-compose"
git push --set-upstream origin main
----

Maintenant que les fichiers sont dans le d√©p√¥t distant, nous allons pouvoir construire l'image Docker depuis notre serveur Jenkins.

image::images/07.png[]

[CAUTION]
====
V√©rifier que votre d√©p√¥t Git est mis √† jour sur le site *GitHub*. Vous devriez voir votre nouveau message
(Ajout du Dockerfile et du docker-compose) (l‚Äôhorodatage de validation a √©t√© mis √† jour).
====



Pour cela, il faut se connecter en `SSH` sur le serveur Jenkins et faire un `git pull` pour r√©cup√©rer la derni√®re version du d√©p√¥t GIT.

[source,bash]
----
cd /home/jenkins/app/calculatrice-jenkins
----
image::images/06.png[]

ensuite :

[source,bash]
----
git pull origin main
----


== Etape 3 : Utilisation de Jenkins pour ex√©cuter une version de notre application

=== Configuration de Docker dans le conteneur Jenkins
L'unit√© fondamentale de Jenkins est le Job (√©galement connu sous le nom de projet). Vous pouvez cr√©er des
t√¢ches qui effectuent diverses t√¢ches, notamment les suivantes :

* R√©cup√©rer du code √† partir d'un r√©f√©rentiel de gestion de code source tel que GitHub, GitLab ‚Ä¶.
* Cr√©er une application √† l'aide d'un script ou d'un outil de construction.
* Cr√©er un package d‚Äôune application et l'ex√©cuter sur un serveur

Dans cette partie, nous allons cr√©er un Job Jenkins simple qui r√©cup√®re la derni√®re version de votre Calculatrice-jenkins √† partir de GitHub et ex√©cute un script de construction. Dans Jenkins, nous pourrons ensuite tester notre application et l'ajouter √† un pipeline de d√©veloppement.

Nous devons donc param√©trer le Socket de Docker pour que Jenkins puisse ex√©cuter des commandes Docker.


* V√©rifions si le socket est bien mont√©
+
[source,bash]
----
docker inspect jenkins --format '{{json .HostConfig.Binds}}' | jq .
----
* R√©cup√©rer le GID du groupe docker (sur l‚Äôh√¥te)
+
[source,bash]
----
getent group docker | cut -d: -f3
----
Exemple : `988` pour ma machine
+
* V√©rification/ajustement des droits du socket sur l‚Äôh√¥te (important) :
+
[source,php]
----
ls -l /var/run/docker.sock
# doit id√©alement √™tre: srw-rw---- 1 root docker ... /var/run/docker.sock
sudo chgrp docker /var/run/docker.sock
sudo chmod 660 /var/run/docker.sock
----
+
* Cr√©er/ajuster le groupe docker dans le conteneur, remplacez XXX par le GID du groupe docker
+
[source,php]
----
# Sur l‚Äôh√¥te : r√©cup√©rer le GID (ex: 988)
HOST_DOCKER_GID=$(getent group docker | cut -d: -f3); echo "$HOST_DOCKER_GID"

# Dans le conteneur : aligner le GID du groupe 'docker' sur celui de l‚Äôh√¥te
docker exec -u root jenkins groupadd -f -g "$HOST_DOCKER_GID" docker || true
docker exec -u root jenkins groupmod -g "$HOST_DOCKER_GID" docker 2>/dev/null || true

# Ajouter l‚Äôutilisateur jenkins au groupe docker
docker exec -u root jenkins usermod -aG docker jenkins
----
+
* Installer le client Docker dans le conteneur Jenkins
+
Par d√©faut, l‚Äôimage `jenkins/jenkins:lts-jdkXX` n‚Äôa pas la commande docker. Il faut l'installer.
+
[NOTE]
====
üîç*Docker socket = API REST Unix*

* Le fichier `/var/run/docker.sock` est un socket Unix expos√© par le daemon Docker (`dockerd`).
* Ce socket est en fait une *API REST locale* : par exemple : `curl --unix-socket /var/run/docker.sock http://localhost/containers/json` permet de lister les conteneurs sans docker d'install√©.

Donc en th√©orie : pas besoin du client docker si nous souhaitons appeler l‚ÄôAPI directement.

‚ö°** Mais alors pourquoi installer docker (le client) ?**

* Le binaire docker n‚Äôest qu‚Äôun client CLI qui parle √† ce socket.

* Jenkins ou les jobs peuvent appeler l‚ÄôAPI REST directement (plugins sp√©cifiques, scripts en curl, librairies).

*Mais dans la pratique :*

Beaucoup de pipelines Jenkins utilisent des √©tapes comme `sh 'docker build ‚Ä¶'`.

Sans le binaire docker, ces commandes √©choueront (_docker: command not found_).

====
+
[source,php]
----
docker exec -u root jenkins bash -lc 'apt-get update && apt-get install -y docker.io && rm -rf /var/lib/apt/lists/*'
----
+
* Red√©marrer le conteneur Jenkins
+
[source,php]
----
docker restart jenkins
----
+
* V√©rifier que le client docker fonctionne
+
[source,php]
----
# V√©rifier l‚Äôappartenance groupe & GID
docker exec jenkins id jenkins         # doit montrer ... 988(docker) chez toi
docker exec jenkins getent group docker

# V√©rifier les droits vus DANS le conteneur
docker exec jenkins ls -l /var/run/docker.sock
# doit √™tre root docker et rw pour le groupe
----
+
Nous devons voir docker dans la liste des groupes.
+
image::images/08.png[]
+
Testons maintenant la commande docker dans le conteneur Jenkins :
+
[source,php]
----
docker exec jenkins docker version
----
+
[NOTE]
====
üß† Pourquoi toutes ces manipulations ?

* Le *noyau* se base sur les *num√©ros (GID)*, pas les noms.

* Tant que le groupe docker dans le conteneur n‚Äôa pas *le m√™me GID que le socket mont√©* (c√¥t√© h√¥te), nous aurons l'erreur :  `permission denied`.

* S‚Äôassurer aussi que le socket est bien `root:docker` et `0660` c√¥t√© h√¥te.
====


=== Cr√©ation d'un Webhook GitHub

Un webhook est un m√©canisme qui permet √† GitHub de pr√©venir automatiquement une application externe (ici Jenkins) lorsqu‚Äôun √©v√©nement survient dans un d√©p√¥t (ex. un push, une pull request, une release‚Ä¶).

üëâ Plut√¥t que Jenkins v√©rifie toutes les minutes si ton code a chang√© (polling), GitHub envoie directement une notification HTTP (un message JSON) √† Jenkins.

* *Automatisation* : d√©clencher un job Jenkins d√®s qu‚Äôil y a un commit sur GitHub.

* *R√©duction de la charge* : √©vite √† Jenkins d‚Äôinterroger GitHub en boucle (poll SCM).

* *Rapidit√©* : la compilation/lancement de tests d√©marre imm√©diatement apr√®s un git push.

* *Coh√©rence DevOps* : int√®gre GitHub (gestion du code) et Jenkins (CI/CD) de fa√ßon fluide.


Pour cr√©er un webhook dans github, il faut aller dans les param√®tres du d√©p√¥t (Settings)


Puis cliquez sur Webhooks :

image::images/16.png[]

Puis cliquez sur `Add Webhook`

image::images/17.png[]

Remplissez le formulaire comme suit :

image::images/18.png[]

Une fois le webhook cr√©√©, nous pourrons brancher ce webhook dans le job Jenkins que nous allons cr√©er.
Github enverra une notification √† Jenkins √† chaque fois qu‚Äôun push sera effectu√© sur le d√©p√¥t vers l'URL enregistr√©e dans le webhook.

Pour ma part, il s'agit de : `http://52.47.185.227:8080/github-webhook/`

Cr√©ons maintenant une GitHub App pour Jenkins.

=== Cr√©ation d'un GitHub App

Une *GitHub App* est une application d√©clar√©e dans GitHub, qui peut interagir avec les d√©p√¥ts d‚Äôun utilisateur ou d‚Äôune organisation.

Elle utilise une authentification par App ID et cl√© priv√©e, au lieu d‚Äôun mot de passe ou d‚Äôun token personnel.

*Pourquoi cr√©er une GitHub App pour Jenkins ?*

* *S√©curit√© renforc√©e* : au lieu de donner ton compte GitHub √† Jenkins, tu cr√©es une App qui a ses propres identifiants.

* *Permissions fines* : tu choisis exactement ce que l‚ÄôApp peut faire (ex. lire le code, g√©rer les PR, etc.).

* *Scalabilit√©* : une App peut √™tre install√©e sur plusieurs d√©p√¥ts ou organisations.

* *Bonne pratique DevOps* : s√©paration claire entre ton compte GitHub personnel et l‚Äôacc√®s machine de Jenkins.


* Allez dans les settings de GitHub ( clique sur votre photo de profil en haut √† gauche) ‚Üí `Developer settings` ‚Üí `GitHub Apps` ‚Üí `New GitHub App`

image::images/19.png[]

* Cliquez sur `New GitHub App` et remplissez le formulaire comme suit :

image::images/20.png[]


image::images/21.png[]

Ensuite dans les permissions, il faut configurer les permissions comme suit :

Laisser les autres permissions par d√©faut.

image::images/22.png[]
image::images/23.png[]
image::images/24.png[]

Puis, nous allons souscrire √† des √©v√©nements :

image::images/25.png[]

Avant de finaliser, cochez la case "Only allow this GitHub App to be installed on private repositories" si votre d√©p√¥t est priv√©.

image::images/26.png[]

image::images/27.png[]

Apr√®s avoir cr√©√© l‚Äôapplication, vous serez redirig√© vers la page de l‚Äôapplication. Vous devez g√©n√©rer une cl√© priv√©e pour l‚Äôapplication.

La cl√© priv√© sera utilis√©e par Jenkins pour s‚Äôauthentifier aupr√®s de GitHub.
Toutefois, le format de la cl√© est au format : *PKCS#1* (`BEGIN RSA PRIVATE KEY`) alors que le plugin Jenkin exige le format *PKCS#8* (`BEGIN PRIVATE KEY`).

Voici une solution rapide pour convertir la cl√© au format *PKCS#8* :

* Copier le contenu de la cl√© priv√©e g√©n√©r√©e par GitHub dans un fichier `private_key_jenkins.pem` sur votre machine Ubuntu.

[source,bash]
.Exemple de contenu de la cl√© .PEM √† copier
----
-----BEGIN RSA PRIVATE KEY-----
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
-----END RSA PRIVATE KEY-----
----

Allez dans le dossier `.ssh` de votre machine jenkins (ici `/home/jenkins/.ssh`) et cr√©ez le fichier `private_key_jenkins.pem` avec le contenu copi√© pr√©c√©demment.

Puis convertissez la cl√© au format PKCS#8 avec la commande suivante :

[source,bash]
----
sudo openssl pkcs8 -topk8 -inform PEM -outform PEM   -in VOTRE_FICHIER_FORMAT_PKCS1.pem -out FICHIER_FORMAT_PKCS8.pem -nocrypt
----

Affichez le contenu du fichier `FICHIER_FORMAT_PKCS8.pem` et copiez-le, nous en aurons besoin pour Jenkins.

Commande :
[source,bash]
----
cat FICHIER_FORMAT_PKCS8.pem
----

Vous pouvez supprimer les fichiers `FICHIER_FORMAT_PKCS8.pem` et `VOTRE_FICHIER_FORMAT_PKCS1.pem` ensuite (Si vous avez bien copi√© le contenu de la cl√© priv√©e au format PKCS#8 sur votre machine Windows).

=== Installer l'application Github dans le d√©p√¥t

Il faut maintenant installer l‚Äôapplication GitHub que nous venons de cr√©er dans le d√©p√¥t `calculatrice-jenkins`.

* Allez dans la page de votre GitHub App et cliquez sur `Install App` dans le menu de gauche.
* Cliquez sur `Install` √† c√¥t√© de votre compte utilisateur (ou organisation si vous avez cr√©√© l‚Äôapplication dans une organisation).
* S√©lectionnez le d√©p√¥t `calculatrice-jenkins` et cliquez sur `Install`.


=== Cr√©ation d'un Credentials dans Jenkins

Il faut maintenant configurer Jenkins pour qu'il puisse utiliser cette GitHub App afin d'acc√©der au d√©p√¥t et capter les √©v√©nements du webhook.

* Cliquez sur l'*engrenage* en haut √† gauche pour acc√©der √† la configuration de *Jenkins* puis sur *Credentials*

image::images/28.png[]

Cliquez sur `System` :

image::images/29.png[]

Puis sur Identifiants Globaux (illimit√©)

image::images/30.png[]

Add Credentials :

image::images/31.png[]

S√©lectionnez `GitHub App` dans le menu d√©roulant `Kind` ou `Type` en fran√ßais.


image::images/32.png[]

* *ID* : `Jenkins-GitHub-App` (ou un autre nom de votre choix)
* *Description* : `GitHub App pour Jenkins`
* *App ID* : Renseignez l'App ID de votre GitHub App (disponible dans la page de votre GitHub App)
* Dans `Avanc√©` n'oubliez pas de sp√©cifier votre nom de d√©p√¥t et r√©pertoire.
* *Private Key* : Collez le contenu de votre cl√© priv√©e au format PKCS#8 (g√©n√©r√©e pr√©c√©demment)

Vous pouvez tester la connexion dans la partie "Test Connection".
Saisissez le nom de votre compte Github (bbauer02 dans mon cas) et cliquez sur `Test Connection`.

image::images/33.png[]

=== Cr√©ation du Job (projet) Jenkins

Un *Job Jenkins* (aussi appel√© Projet) est l‚Äôunit√© de travail fondamentale dans Jenkins.
C‚Äôest une t√¢che automatis√©e que Jenkins va ex√©cuter : compilation, tests, d√©ploiement, analyse de code, etc.

üëâ On peut voir un Job comme une recette que Jenkins suit chaque fois qu‚Äôil doit lancer une action.

Cliquer sur le lien `Cr√©er un job` directement en dessous de la page *Bienvenue sur Jenkins!*.
Vous pouvez √©galement cliquer sur `Nouveau Item` dans le menu de gauche.

üîπ Pourquoi utiliser des Jobs ?

* *Automatiser* les t√¢ches r√©p√©titives du cycle de vie logiciel.
* *Standardiser* les √©tapes (m√™me script pour toute l‚Äô√©quipe).
* *Gagner du temps* (plus besoin d‚Äôex√©cuter manuellement).
* *R√©duire les erreurs humaines*.
* *Int√©grer le DevOps* : Jenkins sert de lien entre le code source, les tests, le d√©ploiement.

Il existe plusieurs types de Jobs Jenkins :

* *Freestyle Project* : le type de job le plus simple et flexible. Permet d‚Äôex√©cuter des scripts shell, des commandes Windows, etc. Pour le configurer, une interface graphique est disponible.

* *Pipeline* : permet de d√©finir des workflows complexes en utilisant un langage de script (Groovy). Id√©al pour les processus CI/CD avanc√©s. La configuration se fait via un fichier `Jenkinsfile` versionn√© avec le code.

* *Multibranch Pipeline* : similaire au Pipeline, mais permet de g√©rer automatiquement plusieurs branches d‚Äôun d√©p√¥t Git. Chaque branche peut avoir son propre `Jenkinsfile`. Jenkins d√©tecte automatiquement les branches d‚Äôun repo Git contenant un `Jenkinsfile`. Utile pour tester chaque branche.

* *Folder* : permet de regrouper plusieurs jobs dans un dossier pour une meilleure organisation.

Concr√®tement, dans le cadre de notre application `calculatrice-jenkins`, nous allons cr√©er un *Freestyle Project* pour r√©cup√©rer le code source depuis GitHub et ex√©cuter des commandes Docker pour construire et lancer l'application.


image::images/09.png[]

Dans le champ `Saisissez un nom` renseigner le nom `BuildCalculatriceJob`.

image::images/10.png[]

Cliquer sur l'onglet `General`, ajouter une description pour votre `Job`. Par exemple, "Mon premier Job
Jenkins."

image::images/11.png[]

Cliquer sur l'onglet `Gestion de code Source` et cliquer sur le bouton radio `Git`. Dans le champ URL du
r√©f√©rentiel, ajouter votre lien de r√©f√©rentiel GitHub pour l'exemple d'application en prenant soin de saisir
votre nom d'utilisateur correctement, car sensible √† la casse.



image::images/12.png[]

Cliquez maintenant sur "Etapes du build" afin d'ajouter un script bash √† ex√©cuter.

Si votre script se trouve √† la racine de votre code source pr√©sent dans le d√©p√¥t Git, le syst√®me Jenkins sera alors capable de le retrouver.

Vous pouvez alors appeler le script par la commande :

[source,bash]
----
bash ./calculatrice-app.sh
----



image::images/13.png[]


Appliquez les modifications et sauvegardez.

image::images/14.png[]

Sur le c√¥t√© gauche, cliquer sur Lancer un build pour d√©marrer le travail. Jenkins va t√©l√©charger votre d√©p√¥t Git et ex√©cuter la command build `bash ./calculatrice-app.sh`. Votre construction devrait r√©ussir parce que vous n'avez rien chang√© dans le code.

Dans la section Historique des builds, cliquer sur votre num√©ro de build qui devrait √™tre le `#2` sauf si vous avez cr√©√© l'application plusieurs fois.

image::images/15.png[]

Cliquez sur le num√©ro du build (ex. #2) pour voir les d√©tails du build.

image::images/34.png[]

Cliquez sur `Console Output` pour voir les logs du build.

Nous retrouvons ici les √©tapes d'ex√©cution du script bash.

* La r√©cup√©ration du code source depuis GitHub.
* L'ex√©cution des commandes de notre script bash.

image::images/35.png[]


=== Pipelines Jenkins

Bien que vous puissiez actuellement ex√©cuter les jobs en cliquant simplement sur le bouton `Build Now` pour le `BuildAppJob`, les projets de d√©veloppement de logiciels sont g√©n√©ralement beaucoup plus complexes.

Ces projets peuvent b√©n√©ficier grandement de l'automatisation des builds pour l'int√©gration continue des changements de code et la cr√©ation continue de builds de d√©veloppement pr√™ts √† √™tre d√©ploy√©s. C'est l'essence m√™me du `CI/CD`.

Un *pipeline* peut √™tre automatis√© pour s'ex√©cuter sur la base d'une vari√©t√© de *d√©clencheurs*, y compris *p√©riodiquement*, sur la base d'un sondage *GitHub* pour les changements, ou √† partir d'un script ex√©cut√© √† distance.

Cependant, dans cette partie, vous allez scripter un pipeline dans Jenkins pour ex√©cuter l'application chaque fois que vous cliquez sur le bouton Build Now du pipeline.

*T√¢che 1 : Modification du script bash*

Nous allons modifier le script bash `calculatrice-app.sh` pour qu'il construise et ex√©cute l'application dans un conteneur Docker.
Nous avons d√©ja dans le d√©p√¥t GIT le fichier `docker-compose.yaml` qui nous permettra de lancer l'application.

[source,bash]
.calculatrice-app.sh
----
#!/bin/bash

echo "********************************"
echo "CONSTRUCTION DE L'APPLICATION SUR LE PORT 3000"
docker-compose up -d --build
echo "********************************"
date
----

Il faut maintenant `push` le script modifi√© sur le d√©p√¥t GIT distant.

Puis lancer le build du `BuildCalculatriceJob` pour v√©rifier que tout fonctionne toujours correctement.

L'application tourne sur le port `3000` de la machine virtuelle Jenkins.

image::images/36.png[]

*T√¢che 2 : Cr√©ation d'un Build qui teste si l'application tourne*

Construire un nouveau Job qui se nommera : `TestCalculatriceJob`.

Ce job aura pour but de tester si l'application tourne bien sur le port `3000`.

* Aucune gestion de code source.
* Cliquer sur l'onglet *Triggers* et cocher la case *Construire apr√®s le build sur d‚Äôautre projets*. Pour les Projects √† surveiller, renseigner le nom `BuildCalculatriceJob`.

image::images/38.png[]

* Cliquez sur l'onglet "Etapes du build" et ajouter une √©tape "Ex√©cuter un script shell".
+
Entrer le script suivant. La commande `if` doit √™tre sur une seule ligne, y compris le ; `then`. Cette commande (grep1) va parcourir la sortie retourn√©e par la commande `cURL` pour voir si `Calculatrice d'Addition"` est retourn√©. Si c'est vrai, le script sort et retourne 0, ce qui signifie qu'il n'y a pas d'erreurs.

[source,bash]
----
if curl http://35.180.46.161:3000 | grep "Calculatrice d'Addition"; then
exit 0
else
exit 1
fi
----

image::images/39.png[]


*T√¢che 3 : Cr√©ation du pipeline Jenkins*

* Cliquer sur le lien Jenkins en haut √† gauche, puis sur `Nouveau Item`
* Dans le champ Saisissez un nom, taper *CalculatricePipeline*.
* S√©lectionner *Pipeline* comme type de t√¢che.
* Faire d√©filer jusqu'en bas et cliquer sur OK.

image::images/37.png[]


Voici le script du pipeline que vous devez saisir dans la section Pipeline :

[source,groovy]
----
node {
    stage('Preparation') {
        catchError(buildResult: 'SUCCESS') {
            sh 'docker stop calculatrice-app'
            sh 'docker rm calculatrice-app'
        }
    }
    stage ('Build') {
        build 'BuildCalculatriceJob'
    }
    stage('Results') {
        build 'TestCalculatriceJob'
    }
}
----

Ce script effectue les op√©rations suivantes :

* Il cr√©e une construction √† un seul noeud par opposition √† une configuration distribu√©e ou multi-noeuds. Les configurations distribu√©es ou multi-noeuds sont pour des pipelines plus grands que celui que vous construisez dans cet exercice et sont au-del√† de la port√©e de ce cours.

* Dans l'√©tape de pr√©paration, `CalculatricePipeline` s'assure d'abord que toutes les instances pr√©c√©dentes du conteneur docker `BuildCalculatriceJob` sont arr√™t√©es et supprim√©es. Mais s'il n'y a pas encore de conteneur en cours d'ex√©cution, vous obtiendrez une erreur. Par cons√©quent, vous utilisez la fonction `catchError` pour attraper toutes les erreurs et renvoyer une valeur "*SUCCESS*". Cela permettra au pipeline de passer √† l'√©tape suivante.

* Dans l'√©tape Build, `CalculatricePipeline` va construire votre `BuildCalculatriceJob`.
* Dans l'√©tape Results, `CalculatricePipeline` va construire votre `TestCalculatriceJob`.
* Cliquer sur *Save*, vous √™tes retournerez au tableau de bord Jenkins de la t√¢che `CalculatricePipeline`


*T√¢che 4 : Ex√©cution du pipeline*

Sur la gauche, cliquer sur Lancer un Build pour ex√©cuter le job `CalculatricePipeline`.

Si vous avez cod√© votre script Pipeline sans erreur, la vue des √©tapes devrait afficher trois cases vertes avec le nombre de secondes n√©cessaires √† la construction de chaque √©tape.

Sinon, cliquer sur Configure √† gauche pour revenir √† la configuration de `CalculatricePipeline` et v√©rifier votre script Pipeline.

image::images/40.png[]

*T√¢che n¬∞4 : V√©rifier la sortie de la console  SamplePipeline*

* Cliquer sur le lien de construction le plus r√©cent, puis cliquer sur `Console Output`. Vous devriez voir un r√©sultat similaire √† ce qui suit :

image::images/41.png[]

[NOTE]
====
Une √©volution souhaitable serait √©galement de stocker le script contenant le pipeline directement dans Git. C‚Äôest tr√®s utile et il suffit de cr√©er un fichier JenkinsFile et de le d√©poser sur Git pour que Jenkins le charge lors du pipeline.
====

*D√©fi* : Cr√©er et utiliser JenkinsFile

* Cr√©er un fichier `Jenkinsfile` √† la racine du d√©p√¥t GIT `calculatrice-jenkins` avec le contenu suivant :

[source,groovy]
----
pipeline {
    agent any
    stages {
        stage('Preparation') {
            steps {
                script {
                    try {
                        sh 'docker stop calculatrice-app'
                        sh 'docker rm calculatrice-app'
                    } catch (Exception e) {
                        echo "No existing container to stop/remove."
                    }
                }
            }
        }
        stage('Build') {
            steps {
                build job: 'BuildCalculatriceJob'
            }
        }
        stage('Results') {
            steps {
                build job: 'TestCalculatriceJob'
            }
        }
    }
}
----

Modifier le job `CalculatricePipeline` pour qu'il utilise le `Jenkinsfile` dans la section Pipeline.
* Dans la section Pipeline, s√©lectionner `Pipeline script from SCM` dans le menu d√©roulant *Definition*.
* S√©lectionner `Git` dans le menu d√©roulant SCM.
* Dans le champ *Repository URL*, saisir l'URL de votre d√©p√¥t GIT.
* Dans le champ *Credentials*, s√©lectionner les credentials GitHub App que vous avez cr√©√©s pr√©c√©demment.
* Dans le champ *Branch Specifier*, saisir `*/main` (ou la branche que vous utilisez).
* Dans le champ *Script Path*, saisir `Jenkinsfile`.
* Cliquer sur *Save*.

image::images/42.png[]

* Lancer un build du job `CalculatricePipeline` et v√©rifier que tout fonctionne correctement.

=== Automatisation du Job

Nous allons maintenant automatiser le job `CalculatricePipeline` pour qu'il s'ex√©cute automatiquement √† chaque fois qu'un push est effectu√© sur le d√©p√¥t GitHub.

Dans Jenkins, nous allons informer l‚Äôapplication qu‚Äôun build de `BuildCalculatriceJob` doit √™tre r√©alis√© √† chaque modification du d√©p√¥t sur GitHub.

`TestCalculatriceJob`, quant lui, est param√©tr√© pour se d√©clencher √† la suite de chaque Build de BuildAppJob.

* T√¢che 1 : Param√©trer `BuildCalculatriceJob` :

Cliquer sur le job `BuildCalculatriceJob` dans le tableau de bord Jenkins.
Cliquer sur `Configurer` dans le menu de gauche.

image::images/43.png[]


Param√©trer le d√©clencheur sur `BuildCalculatriceJob` en cliquant sur "Triggers" puis en s√©lectionnant ¬´ GitHub hook trigger for GITScm polling ¬ª

image::images/44.png[]

Sauvegarder en cliquant sur le bouton ¬´ Save ¬ª en bas de page ¬´ Save ¬ª

* T√¢che 2 : V√©rifier le webhook GitHub

Faire un `git commit` et `git push` sur le d√©p√¥t GIT pour d√©clencher le webhook.

image::images/45.png[]